<p>
将不信任值连接到查询中时，
格式化的SQL查询可能难以维护，调试，并且可能增加SQL注入的风险。 
但是，此规则不会检测到SQL注入（与规则s3649不同），
目标只是突出显示复杂/格式化的查询。
</p>
<h2>检查是否出现以下情况</h2>
<ul>
  <li> 查询的某些部分来自不受信任的值（例如用户输入）。 </li>
  <li> 该查询在代码的其他部分重复/重复。 </li>
  <li> 该应用程序必须支持不同类型的关系数据库。 </li>
</ul>
<p>若存在上述任何一种情况，则存在风险</p>
<h2>推荐的安全编码实践</h2>
<ul>
  <li> 使用 <a href="https://www.owasp.org/index.php/Query_Parameterization_Cheat_Sheet">参数化查询，准备好的语句或存储过程</a> 并将变量绑定到SQL查询参数。</li>
  <li> 如果需要访问数据的抽象层，请考虑使用ORM框架。</li>
</ul>
<h2>敏感代码示例</h2>
<pre>
$id = $_GET['id'];
mysql_connect('localhost', $username, $password) or die('Could not connect: ' . mysql_error());
mysql_select_db('myDatabase') or die('Could not select database');

$result = mysql_query("SELECT * FROM myTable WHERE id = " . $id);  // Sensitive, could be susceptible to SQL injection

while ($row = mysql_fetch_object($result)) {
    echo $row-&gt;name;
}
</pre>
<h2>符合标准的解决方案</h2>
<pre>
$id = $_GET['id'];
try {
    $conn = new PDO('mysql:host=localhost;dbname=myDatabase', $username, $password);
    $conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

    $stmt = $conn-&gt;prepare('SELECT * FROM myTable WHERE id = :id');
    $stmt-&gt;execute(array('id' =&gt; $id));

    while($row = $stmt-&gt;fetch(PDO::FETCH_OBJ)) {
        echo $row-&gt;name;
    }
} catch(PDOException $e) {
    echo 'ERROR: ' . $e-&gt;getMessage();
}
</pre>
<h2>例外</h2>
<p>如果使用硬编码字符串（无串联）调用其中一个函数并且该字符串不包含“ $”符号，则不会引起任何问题。</p>
<pre>
$result = mysql_query("SELECT * FROM myTable WHERE id = 42") or die('Query failed: ' . mysql_error());  // 合规
</pre>
<p>当前实现不遵循变量。 它只会检测连接的或包含<code>$</code>的SQL查询。
直接在函数调用中签名。</p>
<pre>
$query = "SELECT * FROM myTable WHERE id = " . $id;
$result = mysql_query($query);  // 即使是敏感问题也不会引起任何问题
</pre>
<h2>请参阅</h2>
<ul>
  <li> <a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection">OWASP Top 10 2017 Category A1</a> - Injection </li>
  <li> <a href="https://cwe.mitre.org/data/definitions/89">MITRE, CWE-89</a> - Improper Neutralization of Special Elements used in an SQL Command
  </li>
  <li> <a href="https://cwe.mitre.org/data/definitions/564.html">MITRE, CWE-564</a> - SQL Injection: Hibernate </li>
  <li> <a href="https://cwe.mitre.org/data/definitions/20.html">MITRE, CWE-20</a> - Improper Input Validation </li>
  <li> <a href="https://cwe.mitre.org/data/definitions/943.html">MITRE, CWE-943</a> - Improper Neutralization of Special Elements in Data Query Logic
  </li>
  <li> <a href="https://wiki.sei.cmu.edu/confluence/x/ITdGBQ">CERT, IDS00-J.</a> - Prevent SQL injection </li>
  <li> <a href="https://www.sans.org/top25-software-errors/#cat1">SANS Top 25</a> - Insecure Interaction Between Components </li>
  <li> Derived from FindSecBugs rules <a href="https://h3xstream.github.io/find-sec-bugs/bugs.htm#SQL_INJECTION_JPA">Potential SQL/JPQL Injection
  (JPA)</a>, <a href="https://h3xstream.github.io/find-sec-bugs/bugs.htm#SQL_INJECTION_JDO">Potential SQL/JDOQL Injection (JDO)</a>, <a
  href="https://h3xstream.github.io/find-sec-bugs/bugs.htm#SQL_INJECTION_HIBERNATE">Potential SQL/HQL Injection (Hibernate)</a> </li>
</ul>

